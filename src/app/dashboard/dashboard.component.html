<p-toast></p-toast>
<p-confirmDialog header="Confirmación" icon="pi pi-exclamation-triangle"></p-confirmDialog>

<div class="flex justify-content-center flex-wrap">
  <div class="flex align-items-center"><h1>CONTROL DE VEHÍCULOS</h1></div>
</div>
<div class="flex flex-wrap justify-content-center gap-3 card p-4">
  <p-button (click)="showCrearDialog()" label="Ingresar Datos" icon="pi pi-plus" class="w-full sm:w-auto"></p-button>
  <p-button (click)="dialogConsultaVisible = true" label="Consultar Datos" icon="pi pi-search" class="w-full sm:w-auto"></p-button>
  <p-button (click)="dialogOpcionesDespachoVisible = true" label="Realizar Despacho" icon="pi pi-truck" class="w-full sm:w-auto"></p-button>
</div>
<!-- Diálogo de Opciones de Despacho -->
<app-despachar
    [vinsRegistrados]="vehiculos" [(visible)]="dialogOpcionesDespachoVisible" (guardarDespacho)="onDespachoGuardado($event)">
</app-despachar>
<!-- Diálogo de Consulta -->
<p-dialog header="Consulta de Vehículos" [(visible)]="dialogConsultaVisible" [modal]="true" [styleClass]="'w-screen md:w-10 max-h-screen overflow-y-auto'">
  <p-table [value]="vehiculos" selectionMode="multiple" [(selection)]="vehiculoSeleccionado" dataKey="vin" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th class="w-3rem"></th>
        <th>
          Consignatario
          <input pInputText type="text" (input)="applyFilter('consignatario', $event)" placeholder="Buscar..." class="w-full mt-1">
        </th>
        <th>NIT</th>
        <th>
          VIN
          <input pInputText type="text" (input)="applyFilter('vin', $event)" placeholder="Buscar..." class="w-full mt-1">
        </th>
        <th>Año</th>
        <th>
          Marca
          <input pInputText type="text" (input)="applyFilter('marca', $event)" placeholder="Buscar..." class="w-full mt-1">
        </th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-vehiculo>
      <tr [pSelectableRow]="vehiculo"
    *ngIf="shouldDisplayRow(vehiculo)">
        <td><p-tableCheckbox [value]="vehiculo"></p-tableCheckbox></td>
        <td [innerHTML]="getHighlightedText(vehiculo.consignatario, 'consignatario')"></td>
        <td>{{ vehiculo.nit }}</td>
        <td [innerHTML]="getHighlightedText(vehiculo.vin, 'vin')"></td>
        <td>{{ vehiculo.anio | date:'yyyy' }}</td>
        <td [innerHTML]="getHighlightedText(vehiculo.marca, 'marca')"></td>
        <td>
          <div class="flex align-items-center gap-2">
            <span class="p-tag"
                  [ngClass]="{
                    'p-tag-success': !vehiculo.despacho,
                    'p-tag-warning': vehiculo.despacho && vehiculo.estado !== 'Deshabilitado',
                    'p-tag-danger': vehiculo.estado === 'Deshabilitado'
                  }"
                  [pTooltip]="vehiculo.despacho ? 'Despachado como ' + (vehiculo.despacho.tipo || vehiculo.despacho) : 'Disponible para despacho'"
                  tooltipPosition="top">
              {{ getEstadoVehiculo(vehiculo) }}
            </span>
            <button *ngIf="vehiculo.estado === 'Deshabilitado'"
                    pButton icon="pi pi-history"
                    class="p-button-rounded p-button-text p-button-sm"
                    (click)="reactivarVehiculo(vehiculo.vin); $event.stopPropagation()"
                    pTooltip="Reactivar vehículo"
                    tooltipPosition="top"></button>
          </div>
        </td>
        <td>
          <div class="flex gap-1">
            <button pButton icon="pi pi-pencil"
                class="p-button-rounded p-button-success p-button-sm w-2rem"
                (click)="editarVehiculo(vehiculo); $event.stopPropagation()"
                [disabled]="vehiculo.estado === 'Deshabilitado'"
                pTooltip="Editar vehículo" tooltipPosition="top">
          </button>
        <button pButton icon="pi pi-list"
                class="p-button-rounded p-button-info p-button-sm w-2rem ml-2"
                (click)="verDetalleDespacho(vehiculo); $event.stopPropagation()"
                [disabled]="!vehiculo.despacho" pTooltip="Ver detalle de despacho" tooltipPosition="top">
        </button>

          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
<!-- Dialogo para detalles de despacho -->
<p-dialog header="Detalle de Despacho - {{vehiculoConDespacho?.vin}}"
          [(visible)]="mostrarDetalleDespacho" [modal]="true">
  <div *ngIf="vehiculoConDespacho">
    <div class="field mb-4">
      <label class="font-bold">Tipo de Despacho:</label>
      <div>
        <span class="p-tag" [ngClass]="{
          'p-tag-info': getSeverity(vehiculoConDespacho.despacho) === 'info',
          'p-tag-warning': getSeverity(vehiculoConDespacho.despacho) === 'warning'
        }">
          {{ vehiculoConDespacho.despacho || 'No especificado' }}
        </span>
      </div>
    </div>
    <div class="field"><br>
      <label class="font-bold">Motorista:</label>
      <div class="p-card p-2">{{ vehiculoConDespacho.motorista || 'No especificado' }}</div>
    </div>
    <div class="field">
      <label class="font-bold">DUCA:</label>
      <div class="p-card p-2">{{ vehiculoConDespacho.duca || 'No especificado' }}</div>
    </div>
    <div *ngIf="vehiculoConDespacho.despacho === 'DM'" class="field">
      <label class="font-bold">N° BL:</label>
      <div class="p-card p-2">{{ vehiculoConDespacho.bl || 'No especificado' }}</div>
    </div>
    <div *ngIf="vehiculoConDespacho.despacho === 'TRANSITO'" class="field">
      <label class="font-bold">N° BL:</label>
      <div class="p-card p-2d">{{ vehiculoConDespacho.copiaBL || 'No especificado' }}</div>
    </div>
    <div *ngIf="vehiculoConDespacho.despacho === 'TRANSITO'" class="field">
      <label class="font-bold">Tarja:</label>
      <div class="p-card p-2">{{ vehiculoConDespacho.tarja || 'No especificado' }}</div>
    </div>
    <div class="field">
      <label class="font-bold">Observaciones:</label>
      <div class="p-card p-2">{{ vehiculoConDespacho.observaciones || 'Sin observaciones' }}</div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cerrar" icon="pi pi-times" (click)="mostrarDetalleDespacho = false"></p-button>
  </ng-template>
</p-dialog>
<div class="flex justify-between mt-4">
  <p-button label="Exportar a PDF" icon="pi pi-file-pdf" (click)="exportarPDF()"></p-button>
  <div class="flex gap-2">
    <p-button label="Cerrar" icon="pi pi-times" (click)="dialogConsultaVisible = false"></p-button>
  </div>
</div>
</p-dialog>
<!-- Dialogo para ingreso de vehiculos -->
<p-dialog header="Control de vehículos" [modal]="true" [(visible)]="dialogVehiculoVisible">
  <app-vehiculoform
    *ngIf="dialogVehiculoVisible" (guardar)="handleGuardar($event)" (cancelar)="handleCancelar()">
  </app-vehiculoform>
</p-dialog>
